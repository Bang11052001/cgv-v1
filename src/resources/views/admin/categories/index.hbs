<div class="container-fluid">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb my-0 ms-2">
      <li class="breadcrumb-item"><a href="/admin">Home</a></li>
      <li class="breadcrumb-item"><a href="/admin/films">Quản lý phim</a></li>
      <li class="breadcrumb-item active"><span>Danh sách phim</span></li>
    </ol>
  </nav>
</div>
</header>

<div class="body flex-grow-1 px-3">
  <div class="container-lg "> 
    <div class="card">
      <div class="card-body">
        <div class="alert alert-success" role="alert"></div>
        {{>adminFilter}}
        <div class="row mt-2">
          <div class="col col-lg-3">
            <div class="card col">   
                <div class="accordion " id="accordionExample">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                        Trang
                      </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                      <div class="accordion-body">
                        <form action="">
                        <div class="mb-3 d-flex align-items-center">
                          <input class ="table-checkbox form-check-input me-2" type="checkbox" id="form-film-quality-input" name ="genre_id" value={{_id}}>
                          <label>Trang chủ</label>
                        </div>
                          <div class="mb-3 d-flex align-items-center">
                          <input class ="table-checkbox form-check-input me-2" type="checkbox" id="form-film-quality-input" name ="genre_id" value={{_id}}>
                          <label >Ảnh</label>
                        </div>
                          <div class="mb-3 d-flex align-items-center">
                          <input class ="table-checkbox form-check-input me-2" type="checkbox" id="form-film-quality-input" name ="genre_id" value={{_id}}>
                          <label >Ảnh</label>
                        </div>
                        <div class="d-flex justify-content-end"> 
                          <button type="submit" class="btn btn-outline-primary">Thêm vào menu</button>
                        </div>
                      </form>
                      </div>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                        Danh mục phim
                      </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
                      <div class="accordion-body">
                      <form action="/admin/menus/create" method="POST">
                        <div class="mb-3">
                            {{#each filmCategories}}
                              <div>
                              {{#if selected}}
                                <input checked disabled class ="table-checkbox form-check-input form-film-categories-create-input" type="checkbox" id="form-film-quality-input" name ="info" value='{{name}},{{slug}},{{module}}'>
                                <label for="exampleInputPassword1" class="form-label">{{name}}</label>
                              {{/if}}
                              {{#unless selected}}
                              <input class ="table-checkbox form-check-input form-film-categories-create-input" type="checkbox" id="form-film-quality-input" name ="info" value='{{name}},{{slug}},{{module}}'>
                                <label for="exampleInputPassword1" class="form-label">{{name}}</label>
                              {{/unless}}
                              </div>
                            {{/each}}
                          <div class="d-flex justify-content-end"> 
                            <button type="submit" class="btn btn-outline-primary form-film-categories-create-btn">Thêm vào menu</button>
                          </div>
                        </div>
                      </form>
                      </div>
                      </div>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="headingThree">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                        Danh mục bài viết
                      </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
                      <div class="accordion-body">
                      <form action="/admin/menus/create" method="POST">
                        <div class="mb-3">
                          <label for="exampleInputPassword1" class="form-label">Danh mục</label>
                          {{#each newsCategories}}
                            <div>
                              {{#if selected}}
                                <input checked disabled class ="table-checkbox form-check-input" type="checkbox" id="form-film-quality-input" name ="info" value='{{name}},{{slug}}'>
                                <label for="exampleInputPassword1" class="form-label">{{name}}</label>
                              {{/if}}
                              {{#unless selected}}
                                <input class ="table-checkbox form-check-input" type="checkbox" id="form-film-quality-input" name ="info" value='{{name}},{{slug}}'>
                                <label for="exampleInputPassword1" class="form-label">{{name}}</label>
                              {{/unless}}
                            </div>
                          {{/each}}
                          <div class="d-flex justify-content-end"> 
                            <button type="submit" class="btn btn-outline-primary">Thêm vào menu</button>
                          </div>
                        </div>
                      </form>
                      </div>
                    </div>
                  </div>
            </div>
          </div>
          <div class="col col-lg-9">
            <div class="card">
            <table class="table text-center ">
              <thead class ="table-dark">
                <tr>
                  <th scope="col">STT</th>
                  <th class ="table-col-left" scope="col">Tên</th>
                  <th scope="col">Thứ tự</th>
                  <th scope="col">Trạng thái</th>
                  <th scope="col">Tùy chọn</th>
                </tr>
              </thead>
              <tbody>
                {{#each menus}}
                <tr>
                  <td>{{countIndex @index 1}}</td>
                  <td class ="table-col-left">{{name}}</td>
                  <td>{{index}}</td>
                  <td>{{status}}</td>
                <td>     
                  <a href="/admin/menus/update?id={{_id}}"><i class="fa-solid fa-pen-to-square"></i></a>
                  <a data-coreui-toggle="modal" data-coreui-target="#confirmModal" data-id="{{_id}}"><i class="fa-solid fa-xmark" ></i></a>
                </td>
                </tr>
                {{/each}}
              </tbody>
            </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{{!-- modal xác nhận xóa !  --}}
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="exampleModalLiveLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLiveLabel">Thông báo</h5>
        <button class="btn-close" type="button" data-coreui-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Xác nhận xóa!</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary closeBtn" type="button" data-coreui-dismiss="modal">Đóng</button>
        <button class="btn btn-primary deleteBtn" type="button">Xóa</button>
      </div>
    </div>
  </div>
</div>

{{!-- form thực hiện xóa menu  --}}
<form id ="form-delete" method="POST"></form>

{{!-- Toast --}}
<div class="toast-container">
  <div id ="myToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">CGV</strong>
      <small class="text-muted">just now</small>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
    </div>
  </div>
</div>


<script>
  const deleteForm = document.querySelector('#form-delete');
  const confirmModal = document.querySelector('#confirmModal');
  const alertMessage = document.querySelector('.alert');
  const toast = document.querySelector('.toast');
  const formFilmCategoriesBtn = document.querySelector('.form-film-categories-create-btn');
  const formFilmCategoriesInput = document.querySelectorAll('.form-film-categories-create-input');



  // lắng nghe khi modal được hiện thị
  confirmModal.addEventListener('show.coreui.modal', event => {

    const button = event.relatedTarget 
    const id = button.getAttribute('data-id');
    const deleteBtn = document.querySelector('.deleteBtn');
    deleteBtn.onclick = function(){
      fetch('http://localhost:1000/api/menus')
        .then(response => response.json())
        .then(menus => {
          if(menus.some(curr => curr.parent_id == id)){
            $('.closeBtn').click();
            alert('bạn phải xóa các menu con trước!');
          }else{
            deleteForm.setAttribute('action',`/admin/menus/delete?id=${id}&_method=DELETE`);
            deleteForm.submit();
          }
        });
    }
})

  // hàm get cookie
  function getCookie(cname) {
  let name = cname + "=";
  let ca = document.cookie.split(';');
  for(let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}
  
  //hàm xóa cookie
  function delete_cookie(name) {
    document.cookie = name +'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
  }

  // Sau 5s ẩn mess
  var message = decodeURIComponent(getCookie("message"));
  
  // Toast
  $(document).ready(function(){
      if(message)
      {
        $("#myToast").toast("show");
        $(".toast-body").text(message);
        $("#myToast").toast({
          delay: 5000,
          autohidden: false,
        });
        setTimeout(function(){
          delete_cookie('message');
          $("#myToast").toast("hide");
        },3000)
      }
  });

//
  {{!-- formFilmCategoriesBtn.onclick= function(e){
  var info =[];
  const formFilmCategoriesInputChecked = Array.from(formFilmCategoriesInput).filter(curr => {
    if(curr.checked == true){
      return true;
    }
    else  
      return false;
  })

  formFilmCategoriesInputChecked.map(curr => {
    info.push(curr.value);
  })
    console.log('sdf',info)
    e.preventDefault();
    console.log($('.form-film-categories-create-input').val())
    $.ajax({
      url: '/admin/menus/create',
      type: 'POST',
      data: {
          info: info,
      }
    })
    .then(data => {
      console.log('thanh cong');
    })
    .catch(err => {
      console.log('loi ');
    })
  }  --}}


</script>